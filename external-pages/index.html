<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Triguard - Appointment Submission  (Rebuilt)</title>
  <style>
    :root{
      --blue:#0A2C77; --blue-2:#1d4ed8; --red:#C1272D; --ink:#0f172a; --muted:#475569; --bg:#f6f7fb; --card:#ffffff; --bd:#e5e7eb;
      --grad:linear-gradient(135deg,#0A2C77,#1d4ed8);
      --shadow:0 10px 30px rgba(2,6,23,.08);
      --input-bg:#fff; --hint:#94a3b8;
      --fs:20px; /* large base */
    }
    [data-theme="dark"]{
      --blue:#7aa2ff; --blue-2:#4c78ff; --red:#ff6b6b; --ink:#e2e8f0; --muted:#94a3b8; --bg:#0b1220; --card:#0f172a; --bd:#1f2937;
      --grad:linear-gradient(135deg,#0f3a9e,#1f53ff);
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --input-bg:#0b1220; --hint:#64748b;
    }

    *{box-sizing:border-box}
    html{font-size:var(--fs)}
    body{margin:0; font:600 1rem/1.65 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--ink)}
    header{background:var(--grad); color:#fff; padding:1rem 1.25rem; box-shadow:0 10px 28px rgba(2,6,23,.15); position:sticky; top:0; z-index:10}
    header .wrap{max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:.75rem}
    header h1{margin:0; font-weight:900; letter-spacing:.3px; font-size:1.15rem}
    .theme-switch{display:flex; gap:.5rem}
    .theme-btn{border:1px solid rgba(255,255,255,.45); background:transparent; color:#fff; border-radius:12px; padding:.35rem .6rem; cursor:pointer; font-size:1.2rem}

    .container{max-width:1200px; margin:0 auto; padding:1.1rem}
    .grid{display:grid; grid-template-columns:1fr; gap:1rem}
    @media(min-width:1000px){.grid{grid-template-columns:0.9fr 1.1fr}}
    .card{background:var(--card); border:1px solid var(--bd); border-radius:20px; box-shadow:var(--shadow)}
    .p-20{padding:1rem}

    .row{display:flex; flex-wrap:wrap; gap:.75rem}
    .col{flex:1 1 260px}
    label{font-weight:900; display:block; margin:.6rem 0 .35rem; letter-spacing:.2px}
    input, select, textarea{width:100%; padding:1rem; border:1px solid var(--bd); border-radius:14px; background:var(--input-bg); transition:.2s; font:600 1rem/1.4 inherit; color:var(--ink)}
    input:focus,select:focus,textarea:focus{outline:none; border-color:var(--blue); box-shadow:0 0 0 4px color-mix(in oklab, var(--blue) 22%, transparent)}
    input::placeholder{color:var(--hint)}
    textarea{resize:vertical}
    small.helper{display:block; color:var(--muted); margin-top:.25rem}
    .invalid{border-color:#ef4444 !important; box-shadow:0 0 0 4px color-mix(in oklab, #ef4444 20%, transparent) !important}

    .pills{display:flex; gap:.5rem; flex-wrap:wrap}
    .pill-btn{padding:.8rem 1rem; border:1px solid var(--bd); border-radius:999px; background:var(--input-bg); cursor:pointer; transition:.15s; font-weight:900}
    .pill-btn:hover{transform:translateY(-1px); box-shadow:0 6px 14px rgba(2,6,23,.08)}
    .pill-btn.active{background:var(--blue); color:#fff; border-color:var(--blue)}

    /* Booking */
    .legend{display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; font-size:.9rem; color:var(--muted); margin-bottom:.6rem}
    .sw{width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,.05)}
    .notice{font-size:.95rem; background:#fff7ed; border:1px solid #fdba74; padding:.7rem .85rem; border-radius:12px; color:#9a3412; margin-top:.6rem; display:none}
    [data-theme="dark"] .notice{background:#422006; border-color:#9a3412; color:#fde68a}
    .hint{font-size:.9rem; color:var(--muted)}

    /* Calendar */
    .calendar{--cell:56px; display:block; margin-bottom:.75rem}
    .cal-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem}
    .cal-title{display:flex; flex-direction:column; align-items:center}
    .cal-nav{display:flex; gap:.4rem}
    .icon-btn{border:1px solid var(--bd); background:var(--input-bg); width:40px; height:40px; border-radius:12px; cursor:pointer; color:var(--ink); font-size:1.1rem}
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:8px}
    .dayname{font-size:.9rem; color:var(--muted); text-align:center}
    .cal-btn{width:100%; aspect-ratio:1; border-radius:12px; border:1px solid var(--bd); background:var(--input-bg); font-weight:900; cursor:pointer; transition:.15s}
    .cal-btn:hover{filter:brightness(.96)}
    .cal-btn.past{background:color-mix(in oklab, var(--card) 70%, #e5e7eb); color:#9ca3af; cursor:not-allowed}
    .cal-btn.selected{color:#fff; background:var(--red); border-color:var(--red)}

    /* Slots (always vertical; bolder in light mode) */
    #timeSlots.slots{display:grid; grid-template-columns:1fr; gap:.8rem; margin-top:.6rem}
    .slot{position:relative; display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:1.1rem 1rem; border:2px solid var(--bd); border-radius:18px; cursor:pointer; background:var(--input-bg); transition:.18s; font-weight:900; font-size:1.05rem; color:var(--ink)}
    .slot:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(2,6,23,.10); background:color-mix(in oklab, var(--input-bg) 90%, #f8fafc)}
    .slot.active{background:var(--blue); color:#fff; border-color:var(--blue)}
    :not([data-theme="dark"]) .slot{background:linear-gradient(180deg,#ffffff,#f9fbff); border-color:#d1d5db}
    :not([data-theme="dark"]) .slot::before{content:""; position:absolute; left:0; top:10px; bottom:10px; width:4px; border-radius:4px; background:#e5e7eb}
    :not([data-theme="dark"]) .slot.active::before{background:#c7d7ff}

    /* Toast */
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#111827; color:#fff; padding:.75rem .95rem; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); z-index:9999; font-size:1rem; display:none}
    .toast.good{background:#065f46}
    .toast.warn{background:#92400e}

    /* Submit */
    .submit-btn{background:linear-gradient(90deg,var(--red), #e14b52); border:none; padding:.9rem 1.1rem; border-radius:14px; color:#fff; font-weight:900; cursor:pointer; transition:.2s; font-size:1.05rem}

    /* Modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(2,6,23,.55); display:flex; align-items:center; justify-content:center; z-index:10000}
    .modal{width:min(520px, 92vw); background:var(--card); border:1px solid var(--bd); border-radius:14px; box-shadow:0 20px 60px rgba(2,6,23,.25); padding:16px; color:var(--ink)}
    .modal .row-actions{display:flex; gap:.5rem; justify-content:flex-end}
    .btn{display:inline-flex; align-items:center; gap:.5rem; padding:.6rem .85rem; border-radius:12px; border:1px solid var(--bd); background:var(--input-bg); cursor:pointer; color:var(--ink); font-weight:800}
    .btn.primary{background:linear-gradient(90deg,var(--red), #e14b52); color:#fff; border:none}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Triguard Appointment Submission</h1>
    <div class="theme-switch">
      <button class="theme-btn" id="themeLight" title="Light" aria-label="Light theme">‚òÄÔ∏è</button>
      <button class="theme-btn" id="themeDark" title="Dark" aria-label="Dark theme">üåô</button>
    </div>
  </div>
</header>
<main class="container">
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div class="grid">
    <!-- LEFT: Booking -->
    <section class="card p-20" id="bookingCard">
      <div class="cal-head">
        <div class="cal-nav"><button class="icon-btn" id="calPrev" aria-label="Previous month">‚Äπ</button></div>
        <div class="cal-title" id="calTitle"></div>
        <div class="cal-nav"><button class="icon-btn" id="calNext" aria-label="Next month">‚Ä∫</button></div>
      </div>
      <div class="legend">
        <span class="sw" style="background:#16a34a"></span> Today
        <span class="sw" style="background:#86efac"></span> Tomorrow
        <span class="sw" style="background:#fde047"></span> Day after
        <span class="sw" style="background:#f87171"></span> 72h+ (red ‚Üí darker)
      </div>
      <div id="calendar"></div>
      <div id="timeSlots" class="slots"></div>
      <div id="bookingDisclaimer" class="notice">Selecting a time more than 72 hours away may be canceled if not reconfirmed. We‚Äôll follow up to confirm.</div>
    </section>

    <!-- RIGHT: Form -->
    <section class="card p-20">
      <h3 style="margin:0 0 .2rem 0;color:var(--blue)">Customer Intake</h3>
      <small class="helper">All fields marked * are required.</small>
      
      <h4 style="color:var(--blue)">Appointment Type</h4>
      <div class="row">
        <div class="col">
          <label>Appointment Type *</label>
          <div class="pills" data-name="appointmentType">
            <button class="pill-btn active" data-val="physical">Physical Visit</button>
            <button class="pill-btn" data-val="virtual">Virtual Consultation</button>
          </div>
          <small class="helper">Both physical and virtual appointments require a service address for scheduling purposes.</small>
        </div>
      </div>
      <div class="row">
        <div class="col"><label>First name *</label><input id="firstName" autocomplete="given-name"></div>
        <div class="col"><label>Last name *</label><input id="lastName" autocomplete="family-name"></div>
        <div class="col"><label>Phone *</label><input id="phone" inputmode="tel" placeholder="(555) 555‚Äë1234" autocomplete="tel"></div>
        <div class="col"><label>Email</label><input id="email" type="email" placeholder="name@example.com" autocomplete="email"><small id="emailHelp" class="helper"></small></div>
      </div>
      <div id="addressSection">
        <h4 style="color:var(--blue)">Service Address</h4>
        <div class="row">
          <div class="col"><label>Street number *</label><input id="streetNumber" placeholder="123" autocomplete="address-line1"></div>
          <div class="col"><label>Street name *</label><input id="streetName" placeholder="Main St" autocomplete="address-line2"></div>
          <div class="col"><label>City *</label><input id="city" autocomplete="address-level2"></div>
          <div class="col"><label>State *</label>
            <select id="state">
              <option value="">Select state‚Ä¶</option>
              <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option>
              <option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option>
              <option value="DC">District of Columbia</option><option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option>
              <option value="ID">Idaho</option><option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option>
              <option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option>
              <option value="MD">Maryland</option><option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option>
              <option value="MS">Mississippi</option><option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option>
              <option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option>
              <option value="NY">New York</option><option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option>
              <option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option>
              <option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option>
              <option value="UT">Utah</option><option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option>
              <option value="WV">West Virginia</option><option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
            </select>
          </div>
          <div class="col"><label>ZIP *</label><input id="zip" inputmode="numeric" maxlength="10" placeholder="12345 or 12345‚Äë6789" autocomplete="postal-code"></div>
        </div>
      </div>
      <h4 style="color:var(--blue)">Roof & Project Details</h4>
      <div class="row">
        <div class="col"><label>Roof age</label><input id="roofAge" placeholder="e.g., 10 years"></div>
        <div class="col"><label>Main concern</label><input id="roofConcern" placeholder="Leak, shingles, etc."></div>
      </div>
      <div class="row">
        <div class="col"><label>Are you married?</label>
          <div class="pills" data-name="married">
            <button class="pill-btn" data-val="Yes">Yes</button>
            <button class="pill-btn" data-val="No">No</button>
          </div>
        </div>
      </div>
      <div class="row" id="spouseWrap" style="margin-top:.5rem" hidden>
        <div class="col"><label>Spouse first name (optional)</label><input id="spouseFirst" placeholder="They will receive a text message"></div>
        <div class="col"><label>Spouse last name (optional)</label><input id="spouseLast"></div>
        <div class="col"><label>Spouse phone (optional)</label><input id="spousePhone" inputmode="tel" placeholder="(555) 555‚Äë1234"></div>
        <div class="col"><label>Spouse email (optional)</label><input id="spouseEmail" type="email" placeholder="name@example.com"></div>
      </div>
      <div class="row">
        <div class="col"><label>Will all decision makers be present? *</label>
          <div class="pills" data-name="dm">
            <button class="pill-btn" data-val="Yes">Yes</button>
            <button class="pill-btn" data-val="No">No</button>
          </div>
        </div>
      </div>
      <div class="row" id="dmNotesWrap" style="margin-top:.5rem" hidden>
        <div class="col" style="flex-basis:100%"><label>If no, best time for all to be present</label><textarea id="dmNotes" rows="3" placeholder="Add details or alternate times"></textarea></div>
      </div>
      <div class="row">
        <div class="col"><label>Credit score above 650?</label>
          <div class="pills" data-name="creditScore">
            <button class="pill-btn" data-val="Yes">Yes</button>
            <button class="pill-btn" data-val="No">No</button>
          </div>
        </div>
      </div>
      <h4 style="color:var(--blue)">Agent Confirmation</h4>
      <div class="row">
        <div class="col"><label>Agent first name *</label><input id="repFirst" autocomplete="given-name"></div>
        <div class="col"><label>Agent last name *</label><input id="repLast" autocomplete="family-name"></div>
        <div class="col"><label>Team/Region *</label>
          <select id="teamRegion">
            <option value="">Loading regions...</option>
          </select>
        </div>
      </div>
      <div class="row" style="justify-content:space-between; margin-top:.75rem; align-items:center">
        <div class="hint">Submitting creates the lead in EspoCRM and notifies dispatch.</div>
        <button class="submit-btn" id="submitBtn">Submit Intake</button>
      </div>
    </section>
  </div>

  <!-- 72h reconfirm modal -->
  <div id="confirmModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h3 style="margin:0 0 .5rem 0; color:var(--blue)">Reconfirmation Required</h3>
      <p style="margin:0 0 .6rem 0; color:var(--muted)">You chose a date more than <strong>72 hours</strong> away. This may be canceled unless you reconfirm by phone/text. Please acknowledge to continue.</p>
      <label style="display:flex; align-items:center; gap:.5rem; margin-bottom:.6rem">
        <input type="checkbox" id="confirmChk"> <span>I understand I will have to reconfirm this appointment.</span>
      </label>
      <div class="row-actions">
        <button class="btn" id="confirmNo">Cancel</button>
        <button class="btn primary" id="confirmYes" disabled>Confirm & Submit</button>
      </div>
    </div>
  </div>
</main>

<script>
  // Utils & toast
  const $ = s=>document.querySelector(s);
  const $$ = s=>document.querySelectorAll(s);
  function showToast(msg,type='info'){ const t=$('#toast'); if(!t) return; t.textContent=msg; t.className='toast '+(type||''); t.style.display='block'; clearTimeout(window.__toastTimer); window.__toastTimer=setTimeout(()=>{t.style.display='none'}, 2600); }

  // Theme buttons (sun/moon) with persistence
  (function(){
    const root=document.documentElement; const sun=$('#themeLight'); const moon=$('#themeDark');
    function apply(theme){ root.setAttribute('data-theme', theme); localStorage.setItem('tg_theme', theme); sun?.classList.toggle('active', theme!=='dark'); moon?.classList.toggle('active', theme==='dark'); }
    const saved=localStorage.getItem('tg_theme'); apply(saved||'light');
    sun?.addEventListener('click',()=>apply('light'));
    moon?.addEventListener('click',()=>apply('dark'));
  })();

  // Phone masks with caret preservation
  function formatPhone(v){ const d=v.replace(/\D/g,'').slice(0,10); const p=[]; if(d){ p.push('(' + d.slice(0,3)); if(d.length>=3)p.push(') '); if(d.length>=4)p.push(d.slice(3,6)); if(d.length>=6)p.push('-'); if(d.length>=7)p.push(d.slice(6,10)); } return p.join(''); }
  function attachMask(sel){ const el=$(sel); if(!el) return; el.addEventListener('input',()=>{ const pos=el.selectionStart; const before=el.value; el.value=formatPhone(el.value); const diff=el.value.length-before.length; try{ el.setSelectionRange(Math.max(0,pos+diff), Math.max(0,pos+diff)); }catch(_){} }); }
  attachMask('#phone'); attachMask('#spousePhone');

  // Email normalize
  function normalizeEmail(sel,helpSel){ const el=$(sel); const help=$(helpSel); if(!el) return; el.addEventListener('blur',()=>{ el.value=el.value.trim().toLowerCase(); const ok=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(el.value)||el.value===''; if(!ok){ el.classList.add('invalid'); if(help) help.textContent='Please enter a valid email (e.g., name@example.com)'; } else { el.classList.remove('invalid'); if(help) help.textContent=''; } }); }
  normalizeEmail('#email','#emailHelp'); normalizeEmail('#spouseEmail');

  // ZIP 5 or 9
  (function(){ const z=$('#zip'); if(!z) return; z.addEventListener('input',()=>{ let d=z.value.replace(/\D/g,'').slice(0,9); if(d.length>5){ d=d.slice(0,5)+'-'+d.slice(5); } z.value=d; }); })();

  // Booking state
  let selectedDate=null, selectedSlot=null; let reconfirmAckFor=null; // ISO date acknowledged
  function startOfDay(d){const x=new Date(d); x.setHours(0,0,0,0); return x;}
  function sameDay(a,b){return a && b && a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();}
  function dayColor(date){ const today = startOfDay(new Date()); const d = startOfDay(date); const diff = Math.round((d - today)/(1000*60*60*24)); if(diff < 0) return '#e5e7eb'; if(diff === 0) return '#16a34a'; if(diff === 1) return '#86efac'; if(diff === 2) return '#fde047'; const reds = ['#fecaca','#fca5a5','#f87171','#ef4444','#dc2626','#b91c1c','#7f1d1d']; return reds[Math.min(diff-3, reds.length-1)]; }
  function updateDisclaimer(){ const el = $('#bookingDisclaimer'); if(!selectedDate){ el.style.display='none'; return; } const hours = (startOfDay(selectedDate) - startOfDay(new Date()))/(1000*60*60); el.style.display = hours > 72 ? 'block' : 'none'; }

  // Calendar with month navigation
  let currentMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  function renderCalendar(){
    const year = currentMonth.getFullYear(); const month = currentMonth.getMonth(); const today = new Date(); const first = new Date(year, month, 1); const last = new Date(year, month+1, 0);

    const wrap = document.createElement('div'); wrap.className='calendar';
    const title = document.getElementById('calTitle'); if(title){ title.innerHTML = `<div style="font-size:.9rem;color:var(--muted)">${currentMonth.toLocaleString('default',{month:'long'})}</div><div style="font-weight:900; font-size:1.1rem">${year}</div>`; }

    // Day names row
    const names = document.createElement('div'); names.className='cal-grid'; ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(n=>{ const el=document.createElement('div'); el.className='dayname'; el.textContent=n; names.appendChild(el);}); wrap.appendChild(names);

    // Days grid
    const grid = document.createElement('div'); grid.className='cal-grid';
    for(let i=0;i<first.getDay();i++){ grid.appendChild(document.createElement('div')); }
    for(let d=1; d<=last.getDate(); d++){
      const date = new Date(year, month, d);
      const btn = document.createElement('button'); btn.type='button'; btn.className='cal-btn'; btn.textContent=d;
      const past = startOfDay(date) < startOfDay(today);
      if(past){ btn.classList.add('past'); btn.disabled = true; }
      btn.style.background = dayColor(date);
      if(selectedDate && sameDay(selectedDate,date)){ btn.classList.add('selected'); btn.style.color='#fff'; }
      btn.addEventListener('click',()=>{ selectedDate=date; renderCalendar(); renderSlots(); });
      grid.appendChild(btn);
    }
    wrap.appendChild(grid);

    const cal = document.getElementById('calendar'); cal.innerHTML=''; cal.appendChild(wrap);
    document.getElementById('calPrev')?.addEventListener('click', ()=>{ currentMonth = new Date(year, month-1, 1); renderCalendar(); });
    document.getElementById('calNext')?.addEventListener('click', ()=>{ currentMonth = new Date(year, month+1, 1); renderCalendar(); });
  }

  // Slots
  function renderSlots(){
    const slots = ['10:00 AM - 12:00 PM','12:00 PM - 2:00 PM','2:00 PM - 4:00 PM','4:00 PM - 6:00 PM','6:00 PM - 8:00 PM'];
    const container = document.getElementById('timeSlots'); container.innerHTML='';
    if(!selectedDate){ container.innerHTML='<div class="hint">Select a date first.</div>'; updateDisclaimer(); return; }
    slots.forEach(s=>{ const b = document.createElement('button'); b.className='slot'; b.type='button'; b.innerHTML = `<span>${s}</span><span style="opacity:.6">‚Ä∫</span>`; if(selectedSlot===s){ b.classList.add('active'); }
      b.addEventListener('click',()=>{ selectedSlot = (selectedSlot===s? null : s); renderSlots(); const hours=(startOfDay(selectedDate)-startOfDay(new Date()))/(1000*60*60); if(hours>72){ showToast('Heads up: picks beyond 72 hours may auto-cancel unless reconfirmed.', 'warn'); } }); container.appendChild(b); });
    updateDisclaimer();
  }

  // Init calendar & slots
  renderCalendar();
  renderSlots();

  // Fetch and populate regions
  async function fetchRegions() {
    try {
      showToast('Loading regions...', 'info');
      const response = await fetch('https://app.salesdispatcher.com/api/call-center/regions', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': 'cc_api_key_change_this_in_production'
        }
      });

      if (response.ok) {
        const result = await response.json();
        console.log('Regions fetched:', result);
        
        const teamSelect = document.getElementById('teamRegion');
        teamSelect.innerHTML = '<option value="">Select team/region...</option>';
        
        if (result.success && result.data) {
          result.data.forEach(region => {
            const option = document.createElement('option');
            option.value = region.regionId;
            option.textContent = region.name + (region.is_global ? ' (Global)' : '');
            teamSelect.appendChild(option);
          });
          showToast('Regions loaded successfully', 'good');
        } else {
          throw new Error('Invalid response format');
        }
      } else {
        throw new Error(`Failed to fetch regions: ${response.status}`);
      }
    } catch (error) {
      console.error('Error fetching regions:', error);
      const teamSelect = document.getElementById('teamRegion');
      teamSelect.innerHTML = '<option value="">Error loading regions</option>';
      showToast('Failed to load regions', 'warn');
    }
  }

  // Load regions when page loads
  fetchRegions();

  // Pills -> state
  const state={married:'',dm:'',appointmentType:'physical'};
  $$('.pills').forEach(g=>g.addEventListener('click',e=>{ const btn=e.target.closest('.pill-btn'); if(!btn)return; const name=g.dataset.name; const val=btn.dataset.val; g.querySelectorAll('.pill-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); state[name]=val; if(name==='married'){ $('#spouseWrap').hidden=(val!=='Yes'); } if(name==='dm'){ $('#dmNotesWrap').hidden=(val!=='No'); } }));

  // Submit with 72h reconfirm modal
  const modal = document.getElementById('confirmModal'); const confirmChk = document.getElementById('confirmChk'); const confirmYes = document.getElementById('confirmYes'); const confirmNo = document.getElementById('confirmNo');
  confirmChk?.addEventListener('change',()=>{ confirmYes.disabled = !confirmChk.checked; });
  confirmNo?.addEventListener('click',()=>{ modal.style.display='none'; showToast('Submission canceled.', 'warn'); });
  confirmYes?.addEventListener('click',()=>{ modal.style.display='none'; reconfirmAckFor = new Date(selectedDate).toISOString().slice(0,10); doSubmit(); });

  document.getElementById('submitBtn').addEventListener('click',()=>{
    // validations - address is required for both physical and virtual appointments
    let required = ['#firstName','#lastName','#phone','#repFirst','#repLast','#teamRegion','#streetNumber','#streetName','#city','#state','#zip'];
    
    const missing = required.filter(sel=>{ const el=$(sel); const empty = !el || !el.value || el.value.trim()===''; if(el) el.classList.toggle('invalid', empty); return empty; });
    if(missing.length){ showToast('Please fill the required fields.', 'warn'); return; }
    if(!state.dm){ showToast('Confirm whether all decision makers will be present.', 'warn'); return; }
    if(!selectedDate||!selectedSlot){ showToast('Pick a booking date and a time window.', 'warn'); return; }

    const iso = new Date(selectedDate).toISOString().slice(0,10);
    const hours = (startOfDay(selectedDate) - startOfDay(new Date()))/(1000*60*60);
    if(hours>72 && reconfirmAckFor !== iso){ document.getElementById('confirmChk').checked=false; document.getElementById('confirmYes').disabled=true; modal.style.display='flex'; return; }
    doSubmit();
  });

  // Function to geocode address using Nominatim API
  async function geocodeAddress(streetNumber, streetName, city, state, zip) {
    const address = `${streetNumber} ${streetName}, ${city}, ${state} ${zip}`;
    const encodedAddress = encodeURIComponent(address);
    
    try {
      console.log('Geocoding address:', address);
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1&addressdetails=1`);
      const data = await response.json();
      
      if (data && data.length > 0) {
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
        console.log('Geocoding successful:', { lat, lon });
        return { latitude: lat, longitude: lon };
      } else {
        console.warn('No geocoding results found for:', address);
        return { latitude: 0, longitude: 0 };
      }
    } catch (error) {
      console.error('Geocoding error:', error);
      return { latitude: 0, longitude: 0 };
    }
  }

  async function doSubmit(){
    const fullName = `${$('#firstName').value} ${$('#lastName').value}`.trim();
    
    // Convert time slot to military format (start time only)
    let militaryTime = "";
    if(selectedSlot) {
      const timeMatch = selectedSlot.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)/);
      if(timeMatch) {
        let hours = parseInt(timeMatch[1]);
        const minutes = timeMatch[2];
        const ampm = timeMatch[3];
        
        if(ampm === 'PM' && hours !== 12) hours += 12;
        if(ampm === 'AM' && hours === 12) hours = 0;
        
        militaryTime = `${hours.toString().padStart(2, '0')}:${minutes}:00`;
      }
    }
    
    const payload = {
      booking_type: state.appointmentType, // Add appointment type
      customer: {
        name: fullName,
        email: $('#email').value,
        phone: $('#phone').value
      },
      booking: {
        booking_date: new Date(selectedDate).toISOString().slice(0,10),
        booking_time: militaryTime,
        region_id: parseInt($('#teamRegion').value)
      },
      call_center_agent: {
        name: `${$('#repFirst').value} ${$('#repLast').value}`.trim(),
        email: "agent@callcenter.com"
      }
    };

    // Get coordinates from Nominatim API for address
    showToast('Getting address coordinates...', 'info');
    const coordinates = await geocodeAddress(
      $('#streetNumber').value,
      $('#streetName').value, 
      $('#city').value,
      $('#state').value,
      $('#zip').value
    );

    // Location data is required for both physical and virtual appointments
    payload.location = {
      latitude: coordinates.latitude,
      longitude: coordinates.longitude,
      street_number: $('#streetNumber').value,
      street_name: $('#streetName').value,
      postal_code: $('#zip').value,
      city: $('#city').value,
      state_province: $('#state').value,
      country: "USA"
    };

    try {
      showToast('Submitting...', 'info');
      console.log('Sending payload:', payload);
      
      const response = await fetch('https://app.salesdispatcher.com/api/call-center/booking', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': 'cc_api_key_change_this_in_production'
        },
        body: JSON.stringify(payload)
      });

      console.log('Response status:', response.status);
      console.log('Response headers:', Object.fromEntries(response.headers.entries()));

      if (response.ok) {
        const result = await response.json();
        console.log('API Success Response:', result);
        showToast('Appointment booked successfully!', 'good');
      } else {
        const errorText = await response.text();
        console.log('API Error Response:', errorText);
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
    } catch (error) {
      console.error('API Call Error:', error);
      showToast(`Submission failed: ${error.message}`, 'warn');
    }
  }
</script>
</body>
</html>
